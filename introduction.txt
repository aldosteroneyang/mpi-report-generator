# GUI 報告產生器擴充功能 - 患者資料整合指南

## 概述

本文檔說明如何在報告生成器視窗中接收和處理從原始頁面傳送的患者資訊。擴充功能會自動從頁面中提取患者基本資料（性別、年齡、報告編號、病患編號等），並將其傳送到報告生成器視窗中，提供更完整的報告生成體驗。

## 患者資料傳輸機制

擴充功能使用以下方式將患者資料傳送到報告生成器視窗：

1. **URL Fragment 傳輸** (主要方式)：資料被編碼為 Base64 字符串，附加在 URL 的 fragment 部分 (#後面)

## 接收患者資料的方法

要在您的報告生成器頁面中接收這些資料，請在 JavaScript 檔案中添加以下代碼：

```javascript
// 當文檔完成載入時執行
document.addEventListener('DOMContentLoaded', function() {
    console.log('報告生成器：頁面已載入，開始檢查fragment數據');
    
    // 解析URL fragment
    const fragmentString = window.location.hash.substring(1); // 移除開頭的 # 符號
    console.log('報告生成器：URL fragment:', fragmentString);
    
    // 檢查是否有數據
    if (fragmentString && fragmentString.startsWith('data=')) {
        // 提取編碼數據
        const encodedData = fragmentString.substring(5); // 移除 'data=' 部分
        console.log('報告生成器：編碼數據:', encodedData ? encodedData.substring(0, 50) + '...' : '無');
        
        try {
            // 解碼 Base64 資料
            const jsonString = atob(encodedData);
            console.log('報告生成器：解碼後的JSON:', jsonString.substring(0, 100) + '...');
            
            // 解析JSON
            const data = JSON.parse(jsonString);
            console.log('報告生成器：解析後的數據對象:', data);
            
            // 處理數據
            processReceivedData(data);
        } catch (e) {
            console.error('報告生成器：解析URL資料時出錯:', e);
            showErrorMessage('無法解析數據，請檢查控制台錯誤。');
        }
    } else {
        console.log('報告生成器：URL fragment中沒有找到數據');
    }
    
    // 顯示錯誤消息的函數
    function showErrorMessage(message) {
        try {
            const errorDiv = document.createElement('div');
            errorDiv.style.color = 'red';
            errorDiv.style.padding = '10px';
            errorDiv.style.margin = '10px 0';
            errorDiv.style.border = '1px solid red';
            errorDiv.style.borderRadius = '5px';
            errorDiv.style.backgroundColor = '#fff0f0';
            errorDiv.textContent = '資料載入錯誤: ' + message;
            
            document.body.insertBefore(errorDiv, document.body.firstChild);
        } catch (e) {
            console.error('報告生成器：無法顯示錯誤消息:', e);
        }
    }
    
    // 處理接收到的數據
    function processReceivedData(data) {
        console.log('報告生成器：處理接收到的數據');
        
        // 處理MCIID
        if (data.mciid) {
            console.log('報告生成器：接收到MCIID:', data.mciid);
            // 在這裡可以更新頁面上的MCIID
            const mciidElement = document.getElementById('mciid');
            if (mciidElement) {
                mciidElement.textContent = data.mciid;
                mciidElement.value = data.mciid;
            }
        }
        
        // 處理患者資訊
        if (data.patientInfo) {
            console.log('報告生成器：接收到患者資訊');
            handlePatientInfo(data.patientInfo);
        }
        
        // 處理文本值
        if (data.values) {
            console.log('報告生成器：接收到文本值');
            // 尋找頁面上的文本區域
            const textareas = document.querySelectorAll('textarea');
            if (textareas.length > 0) {
                if (Array.isArray(data.values)) {
                    // 按順序填充
                    for (let i = 0; i < Math.min(textareas.length, data.values.length); i++) {
                        if (data.values[i]) {
                            textareas[i].value = data.values[i];
                        }
                    }
                } else if (typeof data.values === 'object') {
                    // 按名稱填充
                    for (const [key, value] of Object.entries(data.values)) {
                        const textarea = document.querySelector(`textarea[name="${key}"], textarea#${key}`);
                        if (textarea) {
                            textarea.value = value;
                        }
                    }
                }
            }
        }
    }
});

// 處理患者資訊的函數 - 更加穩健的版本
function handlePatientInfo(patientInfo) {
    if (!patientInfo) {
        console.error('報告生成器：收到空的患者資訊');
        return;
    }
    
    console.log('報告生成器：處理患者資訊:', patientInfo);
    
    try {
        // 獲取性別資訊，並做標準化處理
        let genderText = '';
        if (patientInfo.gender) {
            // 將數字或代碼轉換為文字
            if (patientInfo.gender === '1' || patientInfo.gender.toLowerCase() === 'm' || patientInfo.gender.includes('男')) {
                genderText = '男';
            } else if (patientInfo.gender === '2' || patientInfo.gender.toLowerCase() === 'f' || patientInfo.gender.includes('女')) {
                genderText = '女';
            } else {
                genderText = patientInfo.gender; // 使用原始值
            }
        }
        
        // 獲取年齡資訊
        const age = patientInfo.age || '';
        
        // 獲取報告編號
        const referno = patientInfo.referno || '';
        
        // 獲取病患編號
        const patno = patientInfo.patno || '';
        
        // 方法1: 填入對應的輸入欄位
        fillInputFields(genderText, age, referno, patno);
        
        // 方法2: 在頁面上顯示患者資訊
        displayPatientInfo(genderText, age, referno, patno);
        
    } catch (e) {
        console.error('報告生成器：處理患者資訊時出錯:', e);
    }
}

// 填入欄位函數
function fillInputFields(gender, age, referno, patno) {
    try {
        // 嘗試找到並填入性別欄位
        const genderElement = document.querySelector('input[name="gender"], #gender, .gender-input');
        if (genderElement) {
            genderElement.value = gender;
            console.log('報告生成器：已填入性別:', gender);
        }
        
        // 嘗試找到並填入年齡欄位
        const ageElement = document.querySelector('input[name="age"], #age, .age-input');
        if (ageElement) {
            ageElement.value = age;
            console.log('報告生成器：已填入年齡:', age);
        }
        
        // 嘗試找到並填入報告編號欄位
        const refernoElement = document.querySelector('input[name="referno"], #referno, .referno-input');
        if (refernoElement) {
            refernoElement.value = referno;
            console.log('報告生成器：已填入報告編號:', referno);
        }
        
        // 嘗試找到並填入病患編號欄位
        const patnoElement = document.querySelector('input[name="patno"], #patno, .patno-input');
        if (patnoElement) {
            patnoElement.value = patno;
            console.log('報告生成器：已填入病患編號:', patno);
        }
    } catch (e) {
        console.error('報告生成器：填入欄位時出錯:', e);
    }
}

// 顯示患者資訊函數
function displayPatientInfo(gender, age, referno, patno) {
    try {
        // 找到或創建顯示患者資訊的區塊
        let patientInfoDiv = document.getElementById('patient-info');
        
        // 如果不存在，則創建一個
        if (!patientInfoDiv) {
            console.log('報告生成器：創建患者資訊顯示區塊');
            patientInfoDiv = document.createElement('div');
            patientInfoDiv.id = 'patient-info';
            patientInfoDiv.className = 'patient-info-container';
            
            // 找一個合適的位置插入
            const insertTarget = document.querySelector('body > div:first-child') || document.body;
            insertTarget.insertBefore(patientInfoDiv, insertTarget.firstChild);
        }
        
        // 填入患者資訊
        let html = '<h3>患者資訊</h3>';
        if (gender) html += `<p>性別: ${gender}</p>`;
        if (age) html += `<p>年齡: ${age}</p>`;
        if (referno) html += `<p>報告編號: ${referno}</p>`;
        if (patno) html += `<p>病患編號: ${patno}</p>`;
        
        patientInfoDiv.innerHTML = html;
        console.log('報告生成器：已顯示患者資訊');
        
        // 添加樣式
        if (!document.getElementById('patient-info-style')) {
            const style = document.createElement('style');
            style.id = 'patient-info-style';
            style.textContent = `
                .patient-info-container {
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    padding: 10px;
                    margin-bottom: 20px;
                    background-color: #f9f9f9;
                }
                .patient-info-container h3 {
                    margin-top: 0;
                    color: #333;
                    border-bottom: 1px solid #eee;
                    padding-bottom: 5px;
                }
                .patient-info-container p {
                    margin: 5px 0;
                }
            `;
            document.head.appendChild(style);
        }
    } catch (e) {
        console.error('報告生成器：顯示患者資訊時出錯:', e);
    }
}
```

## 簡單的HTML範例

在您的HTML中添加以下元素以顯示患者資訊和接收數據：

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>報告生成器</title>
    <script>
        // 這裡粘貼上方的JavaScript代碼
    </script>
</head>
<body>
    <!-- 患者資訊將被自動填入下方區塊 -->
    <div id="patient-info" class="patient-info-container">
        <!-- 患者資訊將由JavaScript動態填入 -->
    </div>
    
    <!-- 表單欄位範例 -->
    <div class="form-container">
        <form id="report-form">
            <div class="form-group">
                <label>性別:</label>
                <input type="text" id="gender" name="gender" class="gender-input">
            </div>
            <div class="form-group">
                <label>年齡:</label>
                <input type="text" id="age" name="age" class="age-input">
            </div>
            <div class="form-group">
                <label>報告編號:</label>
                <input type="text" id="referno" name="referno" class="referno-input">
            </div>
            <div class="form-group">
                <label>病患編號:</label>
                <input type="text" id="patno" name="patno" class="patno-input">
            </div>
        </form>
    </div>
</body>
</html>
```

## 使用 URL Fragment 的優點

1. **不干擾頁面導航**: 使用 URL Fragment (#) 不會觸發頁面重新加載或導航
2. **保持與原始頁面的連接**: 不會破壞與原始頁面的連結關係
3. **安全**: 參數不會被發送到服務器，減少數據暴露風險
4. **容易實現**: 不需要額外的服務器支持

## 測試方法

您可以使用以下方法測試患者資料整合功能:

1. **控制台手動測試**: 在瀏覽器控制台中執行:
   ```javascript
   // 模擬接收患者資訊
   handlePatientInfo({
     gender: '1',
     age: '65',
     referno: '931133P02950',
     patno: '12345'
   });
   ```

2. **URL Fragment測試**: 手動添加fragment測試
   ```
   您的網址#data=eyJtY2lpZCI6IjkzMTAzMDgiLCJwYXRpZW50SW5mbyI6eyJnZW5kZXIiOiJNIiwiYWdlIjoiNjUiLCJyZWZlcm5vIjoiOTMxMTMzUDAyOTUwIiwicGF0bm8iOiIxMjM0NSJ9fQ==
   ```

3. **擴充功能測試**: 啟用擴充功能並點擊「開啟報告生成器」按鈕

## 故障排除

如遇問題，請檢查:

1. **控制台日誌**: 檢查瀏覽器控制台中的詳細日誌訊息
2. **Hash值**: 確認URL hash部分是否包含有效的Base64編碼數據
3. **DOM元素**: 確認患者資訊欄位的ID和選擇器正確

---

如有任何問題或需要技術支援，請聯繫擴充功能開發團隊。
